<!DOCTYPE html>
<html lang="en">
<head>
    {% extends 'base.html' %}

    {% block title %}Voicemail Email Config{% endblock %}

    {% block page_header %}
    <header>
        <h1>Voicemail Email Configuration</h1>
        <div class="controls">
            <a href="/logs" class="btn info">View Logs</a>
            <a href="/statistics" class="btn success">View Statistics</a>
            <a href="/logout" class="btn gray">Logout</a>
        </div>
    </header>
    {% endblock %}

    {% block content %}
        <div class="form-section">
            <h2>Scheduler Control</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <form action="/toggle_scheduler" method="post" style="display: inline;">
                    {% if scheduler_running %}
                        <input type="hidden" name="action" value="stop">
                        <button type="submit" class="btn danger">Stop Scheduler</button>
                    {% else %}
                        <input type="hidden" name="action" value="start">
                        <button type="submit" class="btn success">Start Scheduler</button>
                    {% endif %}
                </form>
                <form action="/run_now" method="post" style="display: inline;">
                    <button type="submit" class="btn secondary">Run Script Now</button>
                </form>
                <p style="margin: 0;">Status: <strong class="{{ 'text-green' if scheduler_running else 'text-red' }}">{{ 'Running' if scheduler_running else 'Stopped' }}</strong></p>
            </div>
        </div>

        <br>

        <form action="/save" method="post">

            <div class="form-section">
                <h2>Mailbox to Email Mappings</h2>
                <p id="recipient_domain_display"> Configured Default Email Domain: @{{ config.O365.recipient_domain | default('') }}</p>
                <div id="mailbox-entries" class="mailbox-entries">
                    {% for mailbox, emails in mailbox_emails.items() %}
                    <div class="mailbox-entry" id="entry-{{ loop.index0 }}" data-container="mailbox">
                        <input type="text" name="mailbox_id_{{ loop.index0 }}" value="{{ mailbox }}">
                        <input type="text" name="emails_{{ loop.index0 }}" value="{{ emails|join(', ') }}" placeholder="comma-separated emails">
                        <input type="hidden" name="original_mailbox_id_{{ loop.index0 }}" value="{{ mailbox }}">
                        <button type="button" class="remove-btn" onclick="removeEntry(this)">Remove</button>
                    </div>
                    {% endfor %}
                </div>
                <hr>
                <h3>Add New Mailbox</h3>
                <div class="mailbox-entry">
                     <input type="text" id="new_mailbox_id" name="new_mailbox_id" placeholder="Mailbox ID">
                     <input type="text" id="new_mailbox_emails" name="new_mailbox_emails" placeholder="comma-separated emails">
                </div>
                <br>
                <button type="submit" class="btn">Save All Settings</button>
            </div>

            <div class="form-section">
                <h2>Custom Mailbox Names</h2>
                <div id="custom-mailbox-names" class="mailbox-entries">
                    {% for mailbox, name in custom_mailbox_names.items() %}
                    <div class="mailbox-entry" id="name-entry-{{ loop.index0 }}" data-container="custom">
                        <input type="text" name="custom_mailbox_id_{{ loop.index0 }}" value="{{ mailbox }}">
                        <input type="text" name="custom_name_{{ loop.index0 }}" value="{{ name }}" placeholder="Custom Name">
                        <input type="hidden" name="original_custom_mailbox_id_{{ loop.index0 }}" value="{{ mailbox }}">
                        <button type="button" class="remove-btn" onclick="removeEntry(this)">Remove</button>
                    </div>
                    {% endfor %}
                </div>
                <hr>
                <h3>Add New Custom Name</h3>
                <div class="mailbox-entry">
                     <input type="text" id="new_custom_mailbox_id" name="new_custom_mailbox_id" placeholder="Mailbox ID">
                     <input type="text" id="new_custom_name" name="new_custom_name" placeholder="Custom Name">
                </div>
                <br>
                <button type="submit" class="btn">Save All Settings</button>
            </div>

            <div class="form-section">
                <h2>General Settings</h2>
                <div class="form-group">
                    <label for="scheduler_interval">Run Interval (minutes)</label>
                    <input type="number" id="scheduler_interval" name="scheduler_interval" value="{{ config.SCHEDULER.interval_minutes | default(15) }}" min="1">
                </div>
                <div class="form-group">
                    <label for="scheduler_enabled_at_startup">Enable Scheduler on Startup</label>
                    <input type="checkbox" id="scheduler_enabled_at_startup" name="scheduler_enabled_at_startup" {% if config.SCHEDULER.scheduler_enabled_at_startup == 'True' %}checked{% endif %}>
                </div>
            </div>

            <div class="form-section">
                <h2>Web Interface Credentials</h2>
                <div class="form-group">
                    <label for="web_user">Username</label>
                    <input type="text" id="web_user" name="web_user" value="{{ config.WEB.user | default('admin') }}">
                </div>
                <div class="form-group">
                    <label for="web_password">New Password (leave blank to keep existing)</label>
                    <input type="password" id="web_password" name="web_password">
                </div>
                <div class="form-group">
                    <label for="web_password_confirm">Confirm New Password</label>
                    <input type="password" id="web_password_confirm" name="web_password_confirm">
                </div>
            </div>

            <div class="form-section">
                <h2>FTP Settings</h2>
                <div class="form-group">
                    <label for="ftp_host">Host</label>
                    <input type="text" id="ftp_host" name="ftp_host" value="{{ config.FTP.host | default('') }}">
                </div>
                <div class="form-group">
                    <label for="ftp_user">User</label>
                    <input type="text" id="ftp_user" name="ftp_user" value="{{ config.FTP.user | default('') }}">
                </div>
                <div class="form-group">
                    <label for="ftp_password">Password (leave blank to keep existing)</label>
                    <input type="password" id="ftp_password" name="ftp_password">
                </div>
                <div class="form-group">
                    <label for="ftp_base_path">Base Path</label>
                    <input type="text" id="ftp_base_path" name="ftp_base_path" value="{{ config.FTP.base_path | default('') }}">
                </div>
            </div>

            <div class="form-section">
                <h2>Office 365 Settings</h2>
                <div class="form-group">
                    <label for="o365_sender_address">Sender Email Address</label>
                    <input type="text" id="o365_sender_address" name="o365_sender_address" value="{{ config.O365.sender_address | default('') }}">
                </div>
                <div class="form-group">
                    <label for="o365_recipient_domain">Sender Email Address</label>
                    <input type="text" id="o365_recipient_domain" name="o365_recipient_domain" value="{{ config.O365.recipient_domain | default('') }}">
                </div>
                <div class="form-group">
                    <label for="o365_client_id">Client ID</label>
                    <input type="text" id="o365_client_id" name="o365_client_id" value="{{ config.O365.client_id | default('') }}">
                </div>
                <div class="form-group">
                    <label for="o365_tenant_id">Tenant ID</label>
                    <input type="text" id="o365_tenant_id" name="o365_tenant_id" value="{{ config.O365.tenant_id | default('') }}">
                </div>
                <div class="form-group">
                    <label for="o365_support_email">Support Email</label>
                    <input type="text" id="o365_support_email" name="o365_support_email" value="{{ config.O365.support_email | default('') }}">
                </div>
                <div class="form-group">
                    <label for="o365_client_secret">Client Secret (leave blank to keep existing)</label>
                    <input type="password" id="o365_client_secret" name="o365_client_secret">
                </div>
            </div>

            <button type="submit" class="btn">Save All Settings</button>
        </form>

        <p>Vibe coded with ❤️ by Smay. I only know how some of this works. Thanks Gemini!</p>
        <p><small>Commit ID: {{ git_commit_id }}</small></p>
    {% endblock %}

    {% block scripts %}
    <script>
        function removeMailbox(entryId) {
            const entry = document.getElementById(entryId);
            if (entry) {
                // Determine which container this entry belongs to so we can reindex correctly
                const isMailbox = entryId.startsWith('entry-');
                const isCustom = entryId.startsWith('name-entry-');
                entry.remove();

                // After removing an entry, reindex the remaining inputs so the server-side
                // sequential while-loop sees contiguous indices (0..n-1).
                if (isMailbox) {
                    reindexMailboxes();
                } else if (isCustom) {
                    reindexCustomNames();
                }
            }
        }

        function reindexMailboxes() {
            const container = document.getElementById('mailbox-entries');
            if (!container) return;
            const entries = container.querySelectorAll('.mailbox-entry');
            entries.forEach((entry, idx) => {
                // Expected order: mailbox id (text), emails (text), original id (hidden)
                const inputs = entry.querySelectorAll('input');
                if (inputs.length >= 3) {
                    inputs[0].name = `mailbox_id_${idx}`;
                    inputs[1].name = `emails_${idx}`;
                    inputs[2].name = `original_mailbox_id_${idx}`;
                } else {
                    // Fallback: try to map by type
                    const textInputs = entry.querySelectorAll('input[type="text"]');
                    const hiddenInput = entry.querySelector('input[type="hidden"]');
                    if (textInputs.length >= 2 && hiddenInput) {
                        textInputs[0].name = `mailbox_id_${idx}`;
                        textInputs[1].name = `emails_${idx}`;
                        hiddenInput.name = `original_mailbox_id_${idx}`;
                    }
                }
                entry.id = `entry-${idx}`;
            });
        }

        function reindexCustomNames() {
            const container = document.getElementById('custom-mailbox-names');
            if (!container) return;
            const entries = container.querySelectorAll('.mailbox-entry');
            entries.forEach((entry, idx) => {
                // Expected order: custom mailbox id (text), custom name (text), original id (hidden)
                const inputs = entry.querySelectorAll('input');
                if (inputs.length >= 3) {
                    inputs[0].name = `custom_mailbox_id_${idx}`;
                    inputs[1].name = `custom_name_${idx}`;
                    inputs[2].name = `original_custom_mailbox_id_${idx}`;
                } else {
                    const textInputs = entry.querySelectorAll('input[type="text"]');
                    const hiddenInput = entry.querySelector('input[type="hidden"]');
                    if (textInputs.length >= 2 && hiddenInput) {
                        textInputs[0].name = `custom_mailbox_id_${idx}`;
                        textInputs[1].name = `custom_name_${idx}`;
                        hiddenInput.name = `original_custom_mailbox_id_${idx}`;
                    }
                }
                entry.id = `name-entry-${idx}`;
            });
        }
    </script>
    {% endblock %}

