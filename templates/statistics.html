{% extends 'base.html' %}

{% block title %}Script Statistics{% endblock %}

{% block page_header %}
<header>
    <div>
        <h1>Script Execution Statistics</h1>
        <div class="summary">
            <div class="last-updated" id="last-updated">Loading…</div>
        </div>
    </div>
    <div class="controls">
        <a href="/" class="btn secondary">Back to Settings</a>
        <button id="refreshBtn" class="btn">Refresh</button>
    </div>
</header>
{% endblock %}

{% block content %}
    <main>
        <section class="stats-grid" id="statsGrid">
            <!-- cards injected here -->
        </section>

        <div class="button-area"></div>

        <div class="raw-area" id="rawArea" hidden>
            <pre id="rawPre">Loading statistics...</pre>
        </div>

        <div class="footer">Auto-refresh every 10s. If the server returns plain text, the raw output will appear
            above.</div>
    </main>
{% endblock %}

{% block scripts %}
<script>
    const statsGrid = document.getElementById('statsGrid');
    const rawArea = document.getElementById('rawArea');
    const rawPre = document.getElementById('rawPre');
    const lastUpdated = document.getElementById('last-updated');
    const refreshBtn = document.getElementById('refreshBtn');
    const buttonArea = document.querySelector('.button-area');


    // store latest JSON and raw view state so raw JSON can remain open across refreshes
    let latestJsonData = null;
    let pageMap = {}
    let rawVisible = false;

    function fmtNumber(n) { return (n === undefined || n === null) ? '—' : n.toLocaleString(); }

    function fmtBytes(b) { if (!b && b !== 0) return '—'; const mb = b / 1024 / 1024; return mb >= 1 ? mb.toFixed(2) + ' MB' : (b / 1024).toFixed(1) + ' KB'; }

    function fmtDate(timestamp) {
        const now = new Date(timestamp * 1000);
        const month = (now.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-indexed, so add 1
        const day = now.getDate().toString().padStart(2, '0');
        const year = now.getFullYear().toString().slice(-2); // Get last two digits of the year

        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');

        const formattedDate = `${month}/${day}/${year} at ${hours}:${minutes}:${seconds}`;

        return formattedDate;
    }

    function buildCard(title, value, sub) {
        const newElement = document.createElement('div'); newElement.className = 'card';
        const titleDiv = document.createElement('div'); titleDiv.className = 'title'; titleDiv.textContent = title;
        const valueDiv = document.createElement('div'); valueDiv.className = 'value'; valueDiv.textContent = value;
        newElement.appendChild(titleDiv);
        newElement.appendChild(valueDiv);
        if (sub) {
            const subDiv = document.createElement('div'); subDiv.className = 'sub'; subDiv.textContent = sub;
            newElement.appendChild(subDiv);
        }
        return newElement;
    }

    async function fetchStatistics() {
        try {
            const res = await fetch('/get_statistics_data');
            if (!res.ok) { throw new Error('Server: ' + res.status); }

            await fetch_stats_page_map();

            const ct = res.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
                const data = await res.json();
                renderFromJson(data);
            } else {
                // try to parse as JSON text, otherwise show raw text
                const text = await res.text();
                try { const data = JSON.parse(text); renderFromJson(data); }
                catch (e) { showRaw(text); }
            }
            const now = new Date(); lastUpdated.textContent = 'Last updated: ' + now.toLocaleString();
        } catch (err) {

            showRaw('Error fetching statistics: ' + err.message);
            lastUpdated.textContent = 'Last update: failed';
        }
    }

    async function fetch_stats_page_map() {
        try {
            const res = await fetch('/stats_page_mapping');
            if (!res.ok) { throw new Error('Server: ' + res.status); }
            const jsonData = await res.json();
            pageMap = jsonData
        } catch (e) {
            // Do nothing. Stats simply display in the automatic form
            console.error('Error fetching stats page map:', e);
            pageMap = {}
        }
    }

    function addRawToggle() {
        buttonArea.innerHTML = '';
        const rawCard = document.createElement('div'); rawCard.className = 'card';
        const btn = document.createElement('button'); btn.className = 'btn secondary'; btn.textContent = rawVisible ? 'Hide raw JSON' : 'View raw JSON';
        btn.onclick = () => {
            rawVisible = !rawVisible;
            rawArea.hidden = !rawVisible;
            btn.textContent = rawVisible ? 'Hide raw JSON' : 'View raw JSON';
            if (rawVisible && latestJsonData) { rawPre.textContent = JSON.stringify(latestJsonData, null, 2); }
        };
        rawCard.appendChild(btn);
        buttonArea.appendChild(rawCard);
    }

    function showRaw(text) {
        rawArea.hidden = false;
        rawPre.textContent = text;
        statsGrid.innerHTML = '';
        rawVisible = true;
        addRawToggle();
    }

    function buildStringDisplayValue(data, field, unit, conversion = "") {
        if (!field || typeof field !== 'string') return '—' + (unit ? ' ' + unit : '');
        const field_path = field.split('.');
        let value = data;
        for (let part of field_path) {
            if (value === undefined || value === null) { value = undefined; break; }
            value = value[part];
        }

        let formatted_value = fmtNumber(value);

        if (conversion === "bytes_to_human_readable") {
            formatted_value = fmtBytes(value);
        }
        if (conversion === "timestamp_range_to_human_readable") {
            formatted_value = fmtDate(value);
        }

        return formatted_value + (unit ? ' ' + unit : '');
    }

    function buildStringDisplayRatio(data, numerator_field, denominator_field, unit) {
        if (!numerator_field || !denominator_field) return '—';
        const num_path = numerator_field.split('.');
        const denom_path = denominator_field.split('.');
        let numerator = data;
        let denominator = data;
        for (let part of num_path) {
            if (numerator === undefined || numerator === null) { numerator = undefined; break; }
            numerator = numerator[part];
        }
        for (let part of denom_path) {
            if (denominator === undefined || denominator === null) { denominator = undefined; break; }
            denominator = denominator[part];
        }
        return `${fmtNumber(numerator)}/${fmtNumber(denominator)} ${unit || ''}`;
    }

    async function renderFromJson(data) {
        // update stored JSON
        latestJsonData = data;
        // if user hasn't opened the raw view, hide the raw area
        if (!rawVisible) { rawArea.hidden = true; rawPre.textContent = ''; }


        statsGrid.innerHTML = '';

        // If cards not defined, show raw JSON but still render the raw toggle button
        if (!pageMap.cards) {
            rawVisible = true;
            rawArea.hidden = !rawVisible;
            rawPre.textContent = JSON.stringify(latestJsonData, null, 2);
            // leave statsGrid empty
        } else {
            // Create page from mapping
            pageMap.cards.forEach(element => {

            let title = element.title || key;
            let main = "No Data";
            if (element.main) {
                if (element.main.display_value) {
                    main = buildStringDisplayValue(
                        data,
                        element.main.display_value.field,
                        element.main.display_value.unit,
                        element.main.display_value.conversion || ""
                    );
                } else if (element.main.display_ratio) {
                    main = buildStringDisplayRatio(
                        data,
                        element.main.display_ratio.numerator_field,
                        element.main.display_ratio.denominator_field,
                        element.main.display_ratio.unit
                    );
                }
            }
            let sub_items = [];
            if (element.sub_fields) {
                Object.entries(element.sub_fields).forEach(([sub_key, sub_field]) => {

                    if (sub_key == 'display_value') {

                        sub_field.forEach(sf => {
                            const sub_value = buildStringDisplayValue(
                                data,
                                sf.field,
                                sf.unit,
                                sf.conversion || ""
                            );
                            sub_items.push(sub_value);
                        });

                    } else if (sub_key == 'display_ratio') {
                        sub_field.forEach(sf => {
                            const sub_value = buildStringDisplayRatio(
                                data,
                                sf.numerator_field,
                                sf.denominator_field,
                                sf.unit
                            );
                            sub_items.push(sub_value);
                        });
                    }
                });
            }
            let sub = '';
            if (sub_items.length > 0) {
                sub = sub_items.join(' · ');
            }
            const card = buildCard(title, main, sub);
            statsGrid.appendChild(card);
        });

        // small raw dump button/area: toggle to view raw JSON (always add this control)
        buttonArea.innerHTML = '';
        const rawCard = document.createElement('div'); rawCard.className = 'card';
        const btn = document.createElement('button'); btn.className = 'btn secondary'; btn.textContent = rawVisible ? 'Hide raw JSON' : 'View raw JSON';
        btn.onclick = () => {
            rawVisible = !rawVisible;
            rawArea.hidden = !rawVisible;
            btn.textContent = rawVisible ? 'Hide raw JSON' : 'View raw JSON';
            if (rawVisible && latestJsonData) { rawPre.textContent = JSON.stringify(latestJsonData, null, 2); }
        };
        rawCard.appendChild(btn);
        buttonArea.appendChild(rawCard);

    }
}

    // initial fetch + interval
    fetchStatistics();
    const intervalId = setInterval(fetchStatistics, 10000);

    // UI handlers
    refreshBtn.addEventListener('click', () => { fetchStatistics(); });

    // cleanup on unload (if SPA), not strictly necessary here
    window.addEventListener('beforeunload', () => clearInterval(intervalId));
</script>
{% endblock %}
